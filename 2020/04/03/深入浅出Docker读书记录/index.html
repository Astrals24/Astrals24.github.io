<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>&lt;&lt;深入浅出Docker&gt;&gt;读书记录 | Astrals</title><meta name="author" content="DSAD"><meta name="copyright" content="DSAD"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta property="og:type" content="article">
<meta property="og:title" content="&lt;&lt;深入浅出Docker&gt;&gt;读书记录">
<meta property="og:url" content="http://example.com/2020/04/03/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BADocker%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="Astrals">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/docker.jpg">
<meta property="article:published_time" content="2020-04-02T16:00:00.000Z">
<meta property="article:modified_time" content="2020-04-03T16:00:00.000Z">
<meta property="article:author" content="DSAD">
<meta property="article:tag" content="网络">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/docker.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/04/03/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BADocker%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '<<深入浅出Docker>>读书记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-04-04 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><meta name="generator" content="Hexo 6.3.0"></head><body><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./../images/%E9%80%8F%E6%98%8E.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Astrals"><span class="site-name">Astrals</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">&lt;&lt;深入浅出Docker&gt;&gt;读书记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-04-02T16:00:00.000Z" title="发表于 2020-04-03 00:00:00">2020-04-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-04-03T16:00:00.000Z" title="更新于 2020-04-04 00:00:00">2020-04-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="&lt;&lt;深入浅出Docker&gt;&gt;读书记录"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="docker-启动详解"><a href="#docker-启动详解" class="headerlink" title="docker 启动详解"></a>docker 启动详解</h3><h5 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建容器并启动  若不加任何参数 默认前台启动</span></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> [OPTIONS] IMAGE [COMMAND] [ARG...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如创建启动centos 若不添加执行命令 其默认执行命令是/bin/bash </span></span><br><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -itd  --name mycentos centos</span></span><br><span class="line"></span><br><span class="line">[root@VM-<span class="number">12</span>-<span class="number">17</span>-centos ~]<span class="comment"># docker inspect centos | grep Cmd -C5</span></span><br><span class="line"><span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line"> ],</span><br><span class="line"> </span><br><span class="line">[root@VM-<span class="number">12</span>-<span class="number">17</span>-centos ~]<span class="comment"># docker inspect mysql | grep Cmd -C5</span></span><br><span class="line"><span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;mysqld&quot;</span></span><br><span class="line"> ],</span><br><span class="line"> ....</span><br><span class="line"><span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;docker-entrypoint.sh&quot;</span></span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只创建容器不启动</span></span><br><span class="line">docker create [OPTIONS] IMAGE [COMMAND] [<span class="keyword">ARG</span>...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看docker 占用分布</span></span><br><span class="line">[root@VM-<span class="number">12</span>-<span class="number">17</span>-centos ~]<span class="comment"># docker system df</span></span><br><span class="line">TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE</span><br><span class="line">Images          <span class="number">59</span>        <span class="number">18</span>        <span class="number">9.998</span>GB   <span class="number">6.048</span>GB (<span class="number">60</span>%)</span><br><span class="line">Containers      <span class="number">28</span>        <span class="number">5</span>         <span class="number">702.1</span>MB   <span class="number">438.5</span>MB (<span class="number">62</span>%)</span><br><span class="line">Local Volumes   <span class="number">23</span>        <span class="number">7</span>         <span class="number">4.011</span>GB   <span class="number">651.1</span>MB (<span class="number">16</span>%)</span><br><span class="line">Build Cache     <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>B        <span class="number">0</span>B</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细占用信息</span></span><br><span class="line">[root@VM-<span class="number">12</span>-<span class="number">17</span>-centos ~]<span class="comment"># docker system df -v</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器cpu，内存占用情况</span></span><br><span class="line">[root@VM-<span class="number">12</span>-<span class="number">17</span>-centos ~]<span class="comment"># docker stats</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="启动参数-i-t-d是什么？"><a href="#启动参数-i-t-d是什么？" class="headerlink" title="启动参数 -i -t -d是什么？"></a>启动参数 -i -t -d是什么？</h5><p>-i  交互式 表示可以读入用户输入的命令</p>
<p>-t 产生一个终端 执行用户输入的命令</p>
<p><strong>所以 -it 往往配合使用</strong> </p>
<p>-d 后台运行容器命令 并打印容器ID  <strong>对于有前台进程或守护进程(如httpd,mysqld)的容器 可以直接使用-d参数创建运行 否则容器将会创建后立即停止 除非指定了一个可以一直执行的命令来保持容器有事情可做</strong></p>
<p>使用-itd 组合参数 可以使得容器在创建运行时设置一个默认或指定的主进程的例如&#x2F;bin&#x2F;bash 保证容器不会因为PID&#x3D;1的进程退出而停止</p>
<p>就docker run来说 若单纯只使用docker run -it  bash 来启动并运行容器 会直接进入容器内部  此时PID&#x3D;1的进程就是bash <strong>这意味着使用exit退出容器时 PID&#x3D;1的主进程被终止 容器也就因此停止.</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以centos为例 此时默认执行的主进程是/bin/bash  若直接使用<span class="built_in">exit</span>退出进程 将导致容器停止</span> </span><br><span class="line">[root@VM-12-17-centos ~]# docker run -it --name mycentos2 centos</span><br><span class="line">[root@431f30934191 /]# ps -elf</span><br><span class="line">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD</span><br><span class="line">4 S root         1     0  1  80   0 -  3009 do_wai 09:27 pts/0    00:00:00 /bin/bash</span><br><span class="line">4 R root        15     1  0  80   0 - 11163 -      09:27 pts/0    00:00:00 ps -elf</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<p>方法一 使用 Ctrl + PQ 组合键退出容器</p>
</blockquote>
</blockquote>
<p>若最初使用的是-it参数来创建并启动的容器,使用Ctrl + PQ 组合键退出容器不会导致当前命令进程被终止 而是在容器后台继续运行.</p>
<blockquote>
<blockquote>
<p>方法二 使用 -itd 组合参数运行容器 <strong>(推荐)</strong></p>
</blockquote>
</blockquote>
<p>直接使用-itd 组合参数来创建并启动容器可以直接在容器后台运行命令而不用进入容器,这样也就保证主进程不会因exit而被终止.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-17-centos ~]# docker run -itd --name mycentos centos</span><br><span class="line">61bb24c54e2832224f3796941a94a32657928b2c552729e1c8a832f7c74182a4</span><br><span class="line">[root@VM-12-17-centos ~]# docker ps --filter name=mycentos</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED              STATUS              PORTS     NAMES</span><br><span class="line">61bb24c54e28   centos    &quot;/bin/bash&quot;   About a minute ago   Up About a minute             mycentos</span><br><span class="line">[root@VM-12-17-centos ~]# docker exec -it mycentos bash</span><br><span class="line">[root@61bb24c54e28 /]# ps -elf</span><br><span class="line">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD</span><br><span class="line">4 S root         1     0  0  80   0 -  3009 poll_s 09:43 pts/0    00:00:00 /bin/bash</span><br><span class="line">4 S root        16     0  0  80   0 -  3009 do_wai 09:45 pts/1    00:00:00 bash</span><br><span class="line">4 R root        30    16  0  80   0 - 11163 -      09:45 pts/1    00:00:00 ps -elf</span><br></pre></td></tr></table></figure>

<p>可以看到再次使用exec -it bash进入容器,并使用exit退出容器时,终止的将只是当前bash 而不是主进程的bash.</p>
<blockquote>
<blockquote>
<p>方法三 使用start 命令再次启动容器</p>
</blockquote>
</blockquote>
<p>若因为使用 -it 参数创建并运行容器 exit退出终端导致容器被停止的情况下,可以直接实现docker start 再次启动容器 这时将不会自动进入容器内部,也就不会因为exit退出而导致容器停止. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-17-centos ~]# docker run -it --name mycentos3 centos  </span><br><span class="line">[root@32bee8ad0d82 /]# ps -elf</span><br><span class="line">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD</span><br><span class="line">4 S root         1     0  0  80   0 -  3009 do_wai 09:51 pts/0    00:00:00 /bin/bash</span><br><span class="line">4 R root        15     1  0  80   0 - 11163 -      09:51 pts/0    00:00:00 ps -elf</span><br><span class="line">[root@32bee8ad0d82 /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@VM-12-17-centos ~]# docker start mycentos3</span><br><span class="line">mycentos3</span><br><span class="line">[root@VM-12-17-centos ~]# docker exec -it mycentos3 bash</span><br><span class="line">[root@32bee8ad0d82 /]# ps -elf</span><br><span class="line">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD</span><br><span class="line">4 S root         1     0  0  80   0 -  3009 poll_s 09:51 pts/0    00:00:00 /bin/bash</span><br><span class="line">4 S root        15     0  0  80   0 -  3009 do_wai 09:52 pts/1    00:00:00 bash</span><br><span class="line">4 R root        30    15  0  80   0 - 11163 -      09:52 pts/1    00:00:00 ps -elf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时使用start再次启动容器的效果和直接使用-itd组合参数的效果一样.</p>
<h5 id="关于启动nginx容器"><a href="#关于启动nginx容器" class="headerlink" title="关于启动nginx容器"></a>关于启动nginx容器</h5><p><strong>对于nginx 使用 docker run -d</strong> </p>
<p>Nginx的docker仓库原文说明如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">If you add a custom CMD in the Dockerfile, be sure to include -g daemon off; in the CMD in order for nginx to stay in the foreground, so that Docker can track the process properly (otherwise your container will stop immediately after starting)!</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Running nginx in debug mode</span><br><span class="line">Images since version 1.9.8 come with nginx-debug binary that produces verbose output when using higher log levels. It can be used with simple CMD substitution:</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --name my-nginx -v /host/path/nginx.conf:/etc/nginx/nginx.conf:ro -d nginx nginx-debug -g <span class="string">&#x27;daemon off;&#x27;</span></span></span><br><span class="line">Similar configuration in docker-compose.yml may look like this:</span><br><span class="line"> </span><br><span class="line">web:</span><br><span class="line">  image: nginx</span><br><span class="line">  volumes:</span><br><span class="line">    - ./nginx.conf:/etc/nginx/nginx.conf:ro</span><br><span class="line">  command: [nginx-debug, &#x27;-g&#x27;, &#x27;daemon off;&#x27;]</span><br></pre></td></tr></table></figure>

<p><strong>以指定nginx daemon off (前台运行) 所以可以直接使用-d</strong></p>
<p><strong>容器的停止与暂停</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用pause 将会暂停容器内所有的进程,但会保留使用内存 使用unpause 可以恢复</span></span><br><span class="line">docker pause</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用stop 将会给主进程发送SIGTERM请求 所有进程将预留的10s的时间来停止自己 10s后未停止的进程 会收到SIGKILL信号,被强制终止.</span></span><br><span class="line">docker stop</span><br></pre></td></tr></table></figure>



<p>若容器内没有ps等命令  需要手动安装组件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install procps vim iproute2</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/run/">官方文档-docker run | Docker Documentation</a></p>
<hr>
<h3 id="镜像的底层存储"><a href="#镜像的底层存储" class="headerlink" title="镜像的底层存储"></a><strong>镜像的底层存储</strong></h3><p>1.只读层</p>
<p>位于镜像最底层，属于基础镜像的层次，以只读方式挂载，readonly+whiteout，</p>
<p>2.可读写层</p>
<p>位于镜像最上层，挂载方式是rw，在写之前目录是空的，一旦对容器进行写操作会以增量的形式出现在该层，若是删除只读层的文件，则AUFS会通过创建whiteout来把只读层的文件遮挡起来。实际的删除操作 其实就是创建了一个.wh的”白障“ 隐藏了需要删除的文件。</p>
<p>3.init层</p>
<p>是以-init结尾的层，夹在只读和可读写层之间，用来存放 <code>/etc/hosts/</code>,<code>etc/resolv.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像分层情况</span></span><br><span class="line">[root@VM-12-17-centos ~]# docker history nginx</span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">c316d5a335a5   2 weeks ago   /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  EXPOSE 80                    0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  ENTRYPOINT [&quot;/docker-entr…   0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop) COPY file:09a214a3e07c919a…   4.61kB    </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop) COPY file:0fd5fca330dcd6a7…   1.04kB    </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop) COPY file:0b866ff3fc1ef5b0…   1.96kB    </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop) COPY file:65504f71f5855ca0…   1.2kB     </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c set -x     &amp;&amp; addgroup --system -…   61.1MB    </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  ENV PKG_RELEASE=1~bullseye   0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  ENV NJS_VERSION=0.7.2        0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  ENV NGINX_VERSION=1.21.6     0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B        </span><br><span class="line">&lt;missing&gt;      2 weeks ago   /bin/sh -c #(nop) ADD file:90495c24c897ec479…   80.4MB </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LowerDir  底层目录；diff</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MergedDir 合并层；容器最终的完整工作目录全部内容在合并层；</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">UpperDir  容器层；数据卷在容器层</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WorkDir	临时层；工作目录</span></span><br><span class="line">[root@VM-12-17-centos ~]# docker inspect nginx</span><br><span class="line">.....</span><br><span class="line">        &quot;GraphDriver&quot;: &#123;</span><br><span class="line">            &quot;Data&quot;: &#123;</span><br><span class="line">                &quot;LowerDir&quot;: &quot;/var/lib/docker/overlay2/f71d0cb3498f29127e6bf51f44447cddb33e267447a238e4e9720f8d9b2fd551/diff:/var/lib/docker/overlay2/56e2ff6ad94708b78e33d6a12831d6bd69b5d37970862a7d515e1ea15f4adcad/diff:/var/lib/docker/overlay2/cb5e3a564eb4c301948f0b83cacad972025c1eb047aae87d40f0ed6779de7adb/diff:/var/lib/docker/overlay2/3b42d68712916841aac9853fed37b6a9fa76dc23f030af36ec1f9702635d592c/diff:/var/lib/docker/overlay2/f25a14707d505e3aac1e572c98d2a52322ade961371d202720b963d3348dd064/diff&quot;,</span><br><span class="line">                &quot;MergedDir&quot;: &quot;/var/lib/docker/overlay2/6e452252fc47326ef211b23c96fffef991f41b7aac62030247c1c1829b8e0b10/merged&quot;,</span><br><span class="line">                &quot;UpperDir&quot;: &quot;/var/lib/docker/overlay2/6e452252fc47326ef211b23c96fffef991f41b7aac62030247c1c1829b8e0b10/diff&quot;,</span><br><span class="line">                &quot;WorkDir&quot;: &quot;/var/lib/docker/overlay2/6e452252fc47326ef211b23c96fffef991f41b7aac62030247c1c1829b8e0b10/work&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Name&quot;: &quot;overlay2&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">....</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">底层LowerDir的最后一个路径为镜像底层linux系统</span></span><br><span class="line">root@VM-12-17-centos work]# cd /var/lib/docker/overlay2/f25a14707d505e3aac1e572c98d2a52322ade961371d202720b963d3348dd064/diff</span><br><span class="line">[root@VM-12-17-centos diff]# ls -i</span><br><span class="line">1051126 bin   1051196 dev  1051367 home  1051575 lib64  1051578 mnt  1051580 proc  1051584 run   1051649 srv  1051651 tmp  1055423 var</span><br><span class="line">1051195 boot  1051197 etc  1051368 lib   1051577 media  1051579 opt  1051581 root  1051587 sbin  1051650 sys  1051652 usr</span><br><span class="line">[root@VM-12-17-centos diff]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现所有nginx容器的linux系统文件inode一致</span></span><br><span class="line">[root@VM-12-17-centos ~]# docker exec -it mynginx bash</span><br><span class="line">root@95386a0daa63:/# ls -i</span><br><span class="line"> 1051126 bin    1180483 docker-entrypoint.d    1051367 home    1051577 media         1 proc   1051587 sbin   1056343 tmp</span><br><span class="line"> 1051195 boot   1180443 docker-entrypoint.sh   1056331 lib     1051578 mnt     1051581 root   1051649 srv    1056344 usr</span><br><span class="line">29756778 dev    1180497 etc		       1051575 lib64   1051579 opt     1051584 run          1 sys    1056512 var</span><br><span class="line">root@95386a0daa63:/# exit</span><br><span class="line">exit</span><br><span class="line">[root@VM-12-17-centos ~]# docker exec -it mynginx2 bash</span><br><span class="line">root@75cc2dc59c57:/# ls -i</span><br><span class="line"> 1051126 bin    1180483 docker-entrypoint.d    1051367 home    1051577 media         1 proc   1051587 sbin   1056343 tmp</span><br><span class="line"> 1051195 boot   1180443 docker-entrypoint.sh   1056331 lib     1051578 mnt     1051581 root   1051649 srv    1056344 usr</span><br><span class="line">29766104 dev    1180574 etc		       1051575 lib64   1051579 opt     1051584 run          1 sys    1056512 var</span><br><span class="line">root@75cc2dc59c57:/# exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-s查看镜像实际占用大小</span> </span><br><span class="line">[root@VM-12-17-centos diff]# docker ps -s</span><br><span class="line">CONTAINER ID   IMAGE       COMMAND                  CREATED       STATUS       PORTS                               NAMES       SIZE</span><br><span class="line">75cc2dc59c57   nginx       &quot;/docker-entrypoint.…&quot;   3 days ago    Up 3 days    0.0.0.0:87-&gt;80/tcp                  mynginx2    20.7MB (virtual 162MB)</span><br><span class="line">95386a0daa63   nginx       &quot;/docker-entrypoint.…&quot;   3 days ago    Up 3 days    0.0.0.0:88-&gt;80/tcp                  mynginx     20.7MB (virtual 162MB)</span><br></pre></td></tr></table></figure>

<p>综上可以发现<strong>每个镜像的不同容器共用一套底层linux</strong>，使得实际占用大小大大缩小了。</p>
<p><strong>批量删除镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除全部镜像</span></span><br><span class="line">docker rmi $(docker images -aq)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用正则筛选</span></span><br><span class="line">docker rmi $(docker images --format &quot;&#123;&#123;.ID&#125;&#125;&quot; --filter reference=&quot;xx/fangzhen/cms:*&quot;)</span><br></pre></td></tr></table></figure>



<p><strong>镜像存储于root空间，若剩余空间容量不组15%，将会发生镜像驱逐。</strong></p>
<h5 id="centos-root扩容"><a href="#centos-root扩容" class="headerlink" title="centos-root扩容"></a><strong>centos-root扩容</strong></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看分区情况</span></span><br><span class="line">[root@localhost ~]# fdisk -l</span><br><span class="line"></span><br><span class="line">Disk /dev/vda: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000bbc00</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/vda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/vda2         2099200     6293503     2097152   82  Linux swap / Solaris</span><br><span class="line">/dev/vda3         6293504    83886079    38796288   83  Linux</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 21474.8 GB, 21474836480000 bytes, 41943040000 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建物理卷</span></span><br><span class="line">pvcreate /dev/sda3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将添加新的物理卷，加载到centos卷组，使用</span></span><br><span class="line">vgextend centos /dev/sda3。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">增加/dev/mapper/centos-root大小，增加50G。使用</span></span><br><span class="line">lvresize -L +50G /dev/mapper/centos-root</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同步文件系统</span></span><br><span class="line">xfs_growfs /dev/mapper/centos-root</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="镜像的写时复制"><a href="#镜像的写时复制" class="headerlink" title="镜像的写时复制"></a><strong>镜像的写时复制</strong></h3><p>修改容器内文件时会在UpperDir创建上层目录来保存修改，<strong>底层镜像那内容永远不会变，它是只读的</strong></p>
<p><strong>docker存储驱动overlay2的基本工作原理如下</strong></p>
<p>我们通过镜像创建的容器包括了三层。最下面的是一个只读的镜像层，第二层是容器层，在他上面最上面的容器挂载层。最上层显示的是我们在容器上直接看见的内容，他通过UnionFS，或者说类似软连接的方式，文件的路径指向了容器层或者是镜像层。当我们尝试读取，修改或者创建一个新的文件时，我们总是从上到下进行搜索，如果在容器层找到了，那么就直接打开；如果容器层没有，那就从镜像层打开。如果是一个新建的文档，那么就从镜像层拷贝到容器层，再打开操作。</p>
<p><img src="/./../images/overlay_constructs.jpg" alt="overlayfs lowerdir，upperdir，合并"></p>
<p>overlay2 对文件的修改采用的是写时复制的工作机制，这种工作机制可以最大程度节省存储空间。具体的文件操作机制如下。</p>
<ul>
<li>第一次修改文件：当我们第一次在容器中修改某个文件时，overlay2 会触发写时复制操作，overlay2 首先从镜像层复制文件到容器层，然后在容器层执行对应的文件修改操作。</li>
</ul>
<blockquote>
<p>overlay2 写时复制的操作将会复制整个文件，如果文件过大，将会大大降低文件系统的性能，因此当我们有大量文件需要被修改时，overlay2 可能会出现明显的延迟。好在，写时复制操作只在第一次修改文件时触发，对日常使用没有太大影响。</p>
</blockquote>
<ul>
<li>删除文件或目录：当文件或目录被删除时，overlay2 并不会真正从镜像中删除它，因为镜像层是只读的，overlay2 会创建一个特殊的文件或目录，这种特殊的文件或目录会阻止容器的访问。</li>
</ul>
<p>AUFS-联合文件系统是曾经的docker存储驱动</p>
<p>docker commit 提交镜像修改</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">官方文档-Docker存储驱动overkay2</a></p>
<hr>
<h3 id="卷挂载方式"><a href="#卷挂载方式" class="headerlink" title="卷挂载方式"></a><strong>卷挂载方式</strong></h3><p>-mount  方式 </p>
<p>在docker-compose中统一配置docker容器,大多数还是选择mount bind因为可以挂单个文件,volume不行,它只能挂目录</p>
<p>bind-mount 其实是一个inode替换的过程，在Linux操作系统中，inode可以理解为存放文件内容的对象，而dentry，也叫目录项，就是访问这个inode所使用的“指针”。</p>
<p>mount –bind &#x2F;home &#x2F;test ，会把&#x2F;home挂载到&#x2F;test上，实际上相当于吧&#x2F;test的&#x2F;dentry，指向修改为&#x2F;home的inode，这样修改&#x2F;test，实际上修改的是&#x2F;home对应的inode。</p>
<p>-v  方式 （常用）</p>
<p>bind挂载 和 volume挂载</p>
<p>-v 绝对路径:容器挂载路径    以宿主机为主 容器或者宿舍机没有文件夹会创建 </p>
<p>-v 卷名称:容器挂载路径        容器有卷没有 卷会创建  容器没有卷有 容器会创建（具名挂载）</p>
<p>-v  容器挂载路径     自动创建卷（匿名挂载）</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/volumes/">官方文档-Docker卷的使用</a></p>
<hr>
<h3 id="Dockerfile指令"><a href="#Dockerfile指令" class="headerlink" title="Dockerfile指令"></a>Dockerfile指令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">. 代表当前目录作为初始上下文环境  若/则是linux的/目录为初始目录</span></span><br><span class="line">docker build -f Dockerfile -t test:1 .</span><br></pre></td></tr></table></figure>



<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作者名称</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wyt&quot;</span> \</span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line"><span class="comment"># 构建与运行 指定初始工作目录为/add </span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /add</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建参数 构建时才生效 </span></span><br><span class="line"><span class="keyword">ARG</span> param=wyt msg=<span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建和运行时都生效</span></span><br><span class="line"><span class="keyword">ENV</span> app=<span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建时运行的指令 没有上下文关系只有并列关系 即用 &amp;&amp; 并列执行</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> 00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把指定内容（可以先ls看当前目录）添加到镜像中，如果是压缩包自动解压，如果是远程文件自动下载  复制到容器中/dest/下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> XXX  /dest/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与ADD的区别是不会自动解压 可指定某用户权限使用 并且ADD可以指定连接</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过卷自动挂载容器内/mysql 和 /app 文件夹 在之后Dockerfile对挂载文件夹所有操作都将弃用 只能在挂载之前修改  并且挂载目录的修改 commit 也将不会生效</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/mysql&quot;</span>,<span class="string">&quot;/app&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行容器时执行的指令（容器启动默认运行的命令） ARG不会生效</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> 00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMD命令可以在容器后带参数修改 并且写多个只有最后一个CMD生效</span></span><br><span class="line"><span class="comment"># [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;xxx&quot;] = shell 如 CMD echo xxx</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo 111;echo <span class="variable">$param</span>&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不变的写ENTRYPOINT 变化的写CMD 互相配合 ENTRYPOINT 是容器启动的唯一入口 cmd是提供参数的</span></span><br><span class="line"><span class="comment"># 若容器启动后带启动参数 则必须与CMD参数数量向一致</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;5&quot;</span>,<span class="string">&quot;baidu.com&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;ping&quot;</span>,<span class="string">&quot;-c&quot;</span>]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>CMD</code>和<code>ENTRYPOINT</code>指令都定义了运行容器时执行的命令。很少有规则描述他们的合作。</p>
<ol>
<li>Dockerfile 应该至少指定一个<code>CMD</code>或<code>ENTRYPOINT</code>命令。</li>
<li><code>ENTRYPOINT</code>应在将容器用作可执行文件时定义。</li>
<li><code>CMD</code>应该用作为<code>ENTRYPOINT</code>命令定义默认参数或在容器中执行临时命令的一种方式。</li>
<li><code>CMD</code>使用替代参数运行容器时将被覆盖。</li>
</ol>
<p>下表显示了针对不同<code>ENTRYPOINT</code>&#x2F;<code>CMD</code>组合执行的命令：</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">No ENTRYPOINT</th>
<th align="left">ENTRYPOINT exec_entry p1_entry</th>
<th align="left">ENTRYPOINT [“exec_entry”, “p1_entry”]</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>No CMD</strong></td>
<td align="left"><em>error, not allowed</em></td>
<td align="left">&#x2F;bin&#x2F;sh -c exec_entry p1_entry</td>
<td align="left">exec_entry p1_entry</td>
</tr>
<tr>
<td align="left"><strong>CMD [“exec_cmd”, “p1_cmd”]</strong></td>
<td align="left">exec_cmd p1_cmd</td>
<td align="left">&#x2F;bin&#x2F;sh -c exec_entry p1_entry</td>
<td align="left">exec_entry p1_entry exec_cmd p1_cmd</td>
</tr>
<tr>
<td align="left"><strong>CMD [“p1_cmd”, “p2_cmd”]</strong></td>
<td align="left">p1_cmd p2_cmd</td>
<td align="left">&#x2F;bin&#x2F;sh -c exec_entry p1_entry</td>
<td align="left">exec_entry p1_entry p1_cmd p2_cmd</td>
</tr>
<tr>
<td align="left"><strong>CMD exec_cmd p1_cmd</strong></td>
<td align="left">&#x2F;bin&#x2F;sh -c exec_cmd p1_cmd</td>
<td align="left">&#x2F;bin&#x2F;sh -c exec_entry p1_entry</td>
<td align="left">exec_entry p1_entry &#x2F;bin&#x2F;sh -c exec_cmd p1_cmd</td>
</tr>
</tbody></table>
<h3 id="Dockerfile多阶段构建"><a href="#Dockerfile多阶段构建" class="headerlink" title="Dockerfile多阶段构建"></a>Dockerfile多阶段构建</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span>  maven:<span class="number">3.6</span>.<span class="number">1</span>-jdk-<span class="number">8</span>-alpine AS buildapp</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> config .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn clean install package <span class="string">&#x27;-Dmaven.test.skip=true&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /app 下面有 target</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">pwd</span> &amp;&amp; <span class="built_in">ls</span> -l</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> /app/target/*.jar  /app.jar</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ls</span> -l</span></span><br><span class="line"><span class="comment">### 以上第一阶段结束，我们得到了一个 app.jar</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 只要一个JRE</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-alpine</span><br><span class="line"><span class="comment">#FROM openjdk:8u282-slim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录最后保存时间 追溯</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">touch</span> /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;astrals24@qq.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把上一个阶段的东西复制过来</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=buildapp /app.jar  /app.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=buildapp /config  /config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -jar  app.jar&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker run -e JAVA_OPTS=&quot;-Xmx512m -Xms33 -&quot; -e PARAMS=&quot;--spring.profiles=dev --server.port=8080&quot; -jar /app/app.jar </span></span><br><span class="line"><span class="comment"># 启动java的命令</span></span><br><span class="line"><span class="comment">#ENV JAVA_OPTS=&quot;&quot;</span></span><br><span class="line"><span class="comment">#ENV PARAMS=&quot;&quot;</span></span><br><span class="line"><span class="comment">#ENTRYPOINT [ &quot;sh&quot;, &quot;-c&quot;, &quot;java -Djava.security.egd=file:/dev/./urandom $JAVA_OPTS -jar /app.jar $PARAMS&quot; ]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">官方文档-Dockerfile</a></p>
<hr>
<h3 id="daemon-json热更新"><a href="#daemon-json热更新" class="headerlink" title="daemon.json热更新"></a>daemon.json热更新</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;],</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;127.0.0.1/8&quot;,&quot;hub.data.wust.edu.cn:30880&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data-root&quot;: &quot;/var/lib/docker&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">    &quot;http://hub-mirror.c.163.com&quot;</span><br><span class="line">  ], </span><br><span class="line">  &quot;insecure-registries&quot; [&quot;127.0.0.1/8&quot;,&quot;hub.data.wust.edu.cn:30880&quot;],</span><br><span class="line">  &quot;max-concurrent-downloads&quot;: 10,</span><br><span class="line">  &quot;live-restore&quot;: true,</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-level&quot;: &quot;warn&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;50m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>修改完daemon.json后，只需要执行以下指令即可 无需重启容器 和  <em>daemon</em>-reload</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> -SIGHUP $(pidof dockerd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否更新</span></span><br><span class="line">docker info </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>可热更新配置</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">debug: it changes the daemon to debug mode when set to true.</span><br><span class="line"> </span><br><span class="line">cluster-store: it reloads the discovery store with the new address.</span><br><span class="line"> </span><br><span class="line">cluster-store-opts: it uses the new options to reload the discovery store.</span><br><span class="line"> </span><br><span class="line">cluster-advertise: it modifies the address advertised after reloading.</span><br><span class="line"> </span><br><span class="line">labels: it replaces the daemon labels with a new set of labels.</span><br><span class="line"> </span><br><span class="line">live-restore: Enables keeping containers alive during daemon downtime.</span><br><span class="line"> </span><br><span class="line">max-concurrent-downloads: it updates the max concurrent downloads for each pull.</span><br><span class="line"> </span><br><span class="line">max-concurrent-uploads: it updates the max concurrent uploads for each push.</span><br><span class="line"> </span><br><span class="line">default-runtime: it updates the runtime to be used if not is specified at container creation. It defaults to “default” which is the runtime shipped with the official docker packages.</span><br><span class="line"> </span><br><span class="line">runtimes: it updates the list of available OCI runtimes that can be used to run containers.</span><br><span class="line"> </span><br><span class="line">authorization-plugin: it specifies the authorization plugins to use.</span><br><span class="line"> </span><br><span class="line">allow-nondistributable-artifacts: Replaces the set of registries to which the daemon will push nondistributable artifacts with a new set of registries.</span><br><span class="line"> </span><br><span class="line">insecure-registries: it replaces the daemon insecure registries with a new set of insecure registries. If some existing insecure registries in daemon’s configuration are not in newly reloaded insecure resgitries, these existing ones will be removed from daemon’s config.</span><br><span class="line"> </span><br><span class="line">registry-mirrors: it replaces the daemon registry mirrors with a new set of registry mirrors. If some existing registry mirrors in daemon’s configuration are not in newly reloaded registry mirrors, these existing ones will be removed from daemon’s config.</span><br><span class="line"> </span><br><span class="line">shutdown-timeout: it replaces the daemon’s existing configuration timeout with a new timeout for shutting down all containers.</span><br><span class="line"> </span><br><span class="line">features: it explicitly enables or disables specific features.</span><br></pre></td></tr></table></figure>



<p>官方docker daemon.json</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;authorization-plugins&quot;: [],</span><br><span class="line">  &quot;data-root&quot;: &quot;&quot;,</span><br><span class="line">  &quot;dns&quot;: [],</span><br><span class="line">  &quot;dns-opts&quot;: [],</span><br><span class="line">  &quot;dns-search&quot;: [],</span><br><span class="line">  &quot;exec-opts&quot;: [],</span><br><span class="line">  &quot;exec-root&quot;: &quot;&quot;,</span><br><span class="line">  &quot;experimental&quot;: false,</span><br><span class="line">  &quot;features&quot;: &#123;&#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [],</span><br><span class="line">  &quot;labels&quot;: [],</span><br><span class="line">  &quot;live-restore&quot;: true,</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;10m&quot;,</span><br><span class="line">    &quot;max-file&quot;:&quot;5&quot;,</span><br><span class="line">    &quot;labels&quot;: &quot;somelabel&quot;,</span><br><span class="line">    &quot;env&quot;: &quot;os,customer&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mtu&quot;: 0,</span><br><span class="line">  &quot;pidfile&quot;: &quot;&quot;,</span><br><span class="line">  &quot;cluster-store&quot;: &quot;&quot;,</span><br><span class="line">  &quot;cluster-store-opts&quot;: &#123;&#125;,</span><br><span class="line">  &quot;cluster-advertise&quot;: &quot;&quot;,</span><br><span class="line">  &quot;max-concurrent-downloads&quot;: 3,</span><br><span class="line">  &quot;max-concurrent-uploads&quot;: 5,</span><br><span class="line">  &quot;default-shm-size&quot;: &quot;64M&quot;,</span><br><span class="line">  &quot;shutdown-timeout&quot;: 15,</span><br><span class="line">  &quot;debug&quot;: true,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;log-level&quot;: &quot;&quot;,</span><br><span class="line">  &quot;tls&quot;: true,</span><br><span class="line">  &quot;tlsverify&quot;: true,</span><br><span class="line">  &quot;tlscacert&quot;: &quot;&quot;,</span><br><span class="line">  &quot;tlscert&quot;: &quot;&quot;,</span><br><span class="line">  &quot;tlskey&quot;: &quot;&quot;,</span><br><span class="line">  &quot;swarm-default-advertise-addr&quot;: &quot;&quot;,</span><br><span class="line">  &quot;api-cors-header&quot;: &quot;&quot;,</span><br><span class="line">  &quot;selinux-enabled&quot;: false,</span><br><span class="line">  &quot;userns-remap&quot;: &quot;&quot;,</span><br><span class="line">  &quot;group&quot;: &quot;&quot;,</span><br><span class="line">  &quot;cgroup-parent&quot;: &quot;&quot;,</span><br><span class="line">  &quot;default-ulimits&quot;: &#123;</span><br><span class="line">    &quot;nofile&quot;: &#123;</span><br><span class="line">      &quot;Name&quot;: &quot;nofile&quot;,</span><br><span class="line">      &quot;Hard&quot;: 64000,</span><br><span class="line">      &quot;Soft&quot;: 64000</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;init&quot;: false,</span><br><span class="line">  &quot;init-path&quot;: &quot;/usr/libexec/docker-init&quot;,</span><br><span class="line">  &quot;ipv6&quot;: false,</span><br><span class="line">  &quot;iptables&quot;: false,</span><br><span class="line">  &quot;ip-forward&quot;: false,</span><br><span class="line">  &quot;ip-masq&quot;: false,</span><br><span class="line">  &quot;userland-proxy&quot;: false,</span><br><span class="line">  &quot;userland-proxy-path&quot;: &quot;/usr/libexec/docker-proxy&quot;,</span><br><span class="line">  &quot;ip&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">  &quot;bridge&quot;: &quot;&quot;,</span><br><span class="line">  &quot;bip&quot;: &quot;&quot;,</span><br><span class="line">  &quot;fixed-cidr&quot;: &quot;&quot;,</span><br><span class="line">  &quot;fixed-cidr-v6&quot;: &quot;&quot;,</span><br><span class="line">  &quot;default-gateway&quot;: &quot;&quot;,</span><br><span class="line">  &quot;default-gateway-v6&quot;: &quot;&quot;,</span><br><span class="line">  &quot;icc&quot;: false,</span><br><span class="line">  &quot;raw-logs&quot;: false,</span><br><span class="line">  &quot;allow-nondistributable-artifacts&quot;: [],</span><br><span class="line">  &quot;registry-mirrors&quot;: [],</span><br><span class="line">  &quot;seccomp-profile&quot;: &quot;&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [],</span><br><span class="line">  &quot;no-new-privileges&quot;: false,</span><br><span class="line">  &quot;default-runtime&quot;: &quot;runc&quot;,</span><br><span class="line">  &quot;oom-score-adjust&quot;: -500,</span><br><span class="line">  &quot;node-generic-resources&quot;: [&quot;NVIDIA-GPU=UUID1&quot;, &quot;NVIDIA-GPU=UUID2&quot;],</span><br><span class="line">  &quot;runtimes&quot;: &#123;</span><br><span class="line">    &quot;cc-runtime&quot;: &#123;</span><br><span class="line">      &quot;path&quot;: &quot;/usr/bin/cc-runtime&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;custom&quot;: &#123;</span><br><span class="line">      &quot;path&quot;: &quot;/usr/local/bin/my-runc-replacement&quot;,</span><br><span class="line">      &quot;runtimeArgs&quot;: [</span><br><span class="line">        &quot;--debug&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;default-address-pools&quot;:[</span><br><span class="line">    &#123;&quot;base&quot;:&quot;172.80.0.0/16&quot;,&quot;size&quot;:24&#125;,</span><br><span class="line">    &#123;&quot;base&quot;:&quot;172.90.0.0/16&quot;,&quot;size&quot;:24&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="docker网络"><a href="#docker网络" class="headerlink" title="docker网络"></a>docker网络</h3><p>Docker网络常见命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出Docker全部网络</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建新的Docker网络</span></span><br><span class="line">docker network create</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建名为overnet的覆盖网络</span></span><br><span class="line">docker network create -d overlay overnet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若不指定-d 则默认bridge模式 在bridge下 会自动创建一个网卡 br-xxx  此网卡对于本自定义网络中的容器充当docker0的效果，</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当其他网络 比如docker0网络中的容器 想连接自定义网络中的容器 需要把该容器加入自定义网络中</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时该容器与自定义网络中的容器通信时将不经过docker0网卡 直接通过veth与自定义网络通信</span></span><br><span class="line">docker network connect 自定义网络名 接入容器名</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询详细信息</span></span><br><span class="line">docker network instpect </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除docker未使用网络</span></span><br><span class="line">docker network prune </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除docker网络</span></span><br><span class="line">docker network rm</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>Docker网络三个主要组成部分：</strong></p>
<p>​			容器网络模型(CNM) ： 规定了docker网络架构的基础组成要素	 k8s 使用的CNI   <a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2016/01/why-kubernetes-doesnt-use-libnetwork/">Why Kubernetes doesn’t use libnetwork</a></p>
<p>​			Libnetwork：是CNM的具体实现的外部类库，Go语言编写，早期从docker daemon中拆分的网络部分。</p>
<p>​			驱动：实现特定网络拓扑方式来扩展模型的能力</p>
<p>CNM 有3个要素</p>
<p>​	沙盒：独立的网络栈 包括以太网接口、端口、路由表和DNS配置</p>
<p>​	终端：虚拟网络接口，负责创建连接并将沙盒连接到网络</p>
<p>​	网络：网桥的软件实现，</p>
<p>Libnetwork</p>
<p>​	除了实现CNM中三个组件还实现了服务发现，基于ingress的负载均衡，网络控制和管理层功能。</p>
<p>​	服务发现 利用了Docker内置的DNS服务器，为每个容器提供DNS解析功能</p>
<p>驱动</p>
<p>​	bridge 负责网络资源的创建和管理</p>
<p>Libnetwork同时激活多个驱动，即docker环境可支持一个庞大的异构网络</p>
<p><strong>docker单机桥接网络</strong>	–  对外发布服务依赖于端口映射 不易扩展 只适合小型项目</p>
<p>单机桥接网络中的容器只能与位于<strong>相同网络中的容器进行通信</strong> ，可以通过端口映射来绕开这个限制。<strong>（这里的端口映射如何实现的？）</strong></p>
<ul>
<li>bridge</li>
</ul>
<p>默认模式，此模式会为每一个容器分配、设置IP等，并将容器连接到一个docker0虚拟网桥，通过docker0网桥以及Iptables nat表配置与宿主机通信。</p>
<p>我们每启动一个docker容器，docker就会给docker容器分配一个ip,并且多一对网卡（容器和主机分别+1）<strong>veth-pair技术实现</strong></p>
<img src="./../images/docker0原理.png" alt="img" style="zoom: 80%;" />



<ul>
<li>host（<strong>本质是不会为进程启用 Network Namespace，所以和宿主机其他进程一样，直接共享宿主机网络栈。</strong>）</li>
</ul>
<p>容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。</p>
<p>host 模式简单并且性能高，host 模式下面的网络模型是最简单和最低延迟的模式，容器进程直接与主机网络接口通信，与物理机性能一致，host 不利于网络自定</p>
<p>配置和管理，并且所有主机的容器使用相同的IP。也不利于主机资源的利用。<strong>对网络性能要求比较高，可以使用该模式。否则应该使用其他模式</strong></p>
<ul>
<li>none</li>
</ul>
<p>该模式关闭了容器的网络功能。</p>
<p><strong>想要容器之间通过容器名互相访问 需要新建自定义网络，</strong></p>
<p>默认网络和自定义网络区别<br>说到这里可能有人会问了，那默认的网卡的网卡驱动也是 bridge 模式的，用户自定义的网络也是 bridge 模式，不就是换了一个名字吗，为什么默认的网卡不可以使用别名进行 IP 地址解析呢？</p>
<p>这个问题问得好，官方特意解释了这两个网卡的区别。</p>
<p>User-defined bridges provide automatic DNS resolution between containers.<br>Containers on the default bridge network can only access each other by IP addresses, unless you use the –link option, which is considered legacy. On a user-defined bridge network, containers can resolve each other by name or alias.<br>翻译过来大意：就是用户自定义的网卡可以在容器之间提供自动的 DNS 解析，缺省的桥接网络上的容器只能通过 IP 地址互相访问，除非使用 –link 参数。在用户自定义的网卡上，容器直接可以通过名称或者别名相互解析。</p>
<p>文档中提到了 –link 参数，官方文档中已经不推荐使用 –link 参数，并且最终可能会被删除，所以最好不要使用 –link 参数来连接两个容器，并且它有多个缺点。</p>
<p>如果使用 –link 参数，需要在容器之间手动创建链接，这些链接需要双向创建，如果容器多于两个的话，将会很困难。或者也可以通过编辑 hosts 文件的方式来指定解析结果，但是这样将会非常难以调试。</p>
<p>默认网卡测试<br>默认网卡 Name 为bridge ，使用该网段，容器间可以互相通过容器ip访问，但是无法通过容器名字互相访问或者进行自身访问。</p>
<p>总结</p>
<p>以上就是通过自定义网卡来使两个容器互相连接的方法，这种方法便于部署和调试，而且还提供了网络隔离功能，两个容器之间不会互相干扰，可以随时断开或者连接，并且可以使用 –subnet 参数指定自定义网络的 IP 段，这里就不详细展开了。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/moyu11111/article/details/120841853">https://blog.csdn.net/moyu11111/article/details/120841853</a></p>
<p><strong>单机网络 - veth-pair  -  Linux namespace技术</strong></p>
<p>默认的bridge网络被映射到内核中为docker0的Linux网桥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-17-centos ~]# docker inspect bridge </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;503c0700d33f270ca864970fa024534ecc0bf8c5103a6ad26850fb2aabf0249e&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-01-12T19:46:21.418794069+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: null,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;</span><br><span class="line">            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span><br><span class="line">            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p><strong>bridge详解</strong></p>
<p>在bridge模式下，连在同一网桥上的容器可以相互通信（若出于安全考虑，也可以禁止它们之间通信，方法是在DOCKER_OPTS变量中设置<code>--icc=false</code>，这样只有使用<code>--link</code>才能使两个容器通信）。</p>
<p>Docker可以开启容器间通信（意味着默认配置<code>--icc=false</code>），也就是说，宿主机上的所有容器可以不受任何限制地相互通信，这可能导致拒绝服务攻击。进一步地，Docker可以通过<code>--ip_forward</code>和<code>--iptables</code>两个选项控制容器间、容器和外部世界的通信。</p>
<p>容器也可以与外部通信，我们看一下主机上的Iptable规则，可以看到这么一条</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>这条规则会将源地址为172.17.0.0&#x2F;16的包（也就是从Docker容器产生的包），并且不是从docker0网卡发出的，进行源地址转换，转换成主机网卡的地址。这么说可能不太好理解，举一个例子说明一下。假设主机有一块网卡为eth0，IP地址为10.10.101.105&#x2F;24，网关为10.10.101.254。从主机上一个IP为172.17.0.1&#x2F;16的容器中ping百度（180.76.3.151）。IP包首先从容器发往自己的默认网关docker0，包到达docker0后，也就到达了主机上。然后会查询主机的路由表，发现包应该从主机的eth0发往主机的网关10.10.105.254&#x2F;24。接着包会转发给eth0，并从eth0发出去（主机的ip_forward转发应该已经打开）。这时候，上面的Iptable规则就会起作用，对包做SNAT转换，将源地址换为eth0的地址。这样，在外界看来，这个包就是从1	0.10.101.105上发出来的，<strong>Docker容器对外是不可见的。</strong></p>
<p>那么，外面的机器是如何访问Docker容器的服务呢？我们首先用下面命令创建一个含有web应用的容器，将容器的80端口映射到主机的80端口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name=nginx_bridge --net=bridge -p 80:80 -d nginx</span><br></pre></td></tr></table></figure>

<p>然后查看Iptable规则的变化，发现多了这样一条规则：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A DOCKER ! -i docker0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.17.0.2:80</span><br></pre></td></tr></table></figure>

<p>此条规则就是对主机eth0收到的目的端口为80的tcp流量进行DNAT转换，将流量发往172.17.0.2:80，也就是我们上面创建的Docker容器。所以，外界只需访问10.10.101.105:80就可以访问到容器中的服务。</p>
<p>除此之外，我们还可以自定义Docker使用的IP地址、DNS等信息，甚至使用自己定义的网桥，但是其工作方式还是一样的。</p>
<p><strong>接入现有网络 容器化应用和未容器化部分</strong></p>
<p> docker内置驱动 MacVLAN</p>
<p>可直接通过主机接口访问容器接口	缺点是要将主机网卡设置为混杂模式 公有云不支持</p>
<p>设置 macvlan 可为容器提供的ip范围参数之后 可以为容器创造出 MAC和IP 地址</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/DeepRoute_Lab/article/details/126347110">https://blog.csdn.net/DeepRoute_Lab/article/details/126347110</a></p>
<p><strong>Docker DNS服务 内置DNS解析器  embedded DNS server</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-17-centos ~]# cat /etc/resolv.conf </span><br><span class="line">; generated by /usr/sbin/dhclient-script</span><br><span class="line">nameserver 183.60.83.19</span><br><span class="line">nameserver 183.60.82.98</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看监听端口</span></span><br><span class="line">[root@VM-12-17-centos ~]# netstat -l</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看流量路径</span></span><br><span class="line">[root@VM-12-17-centos ~]# iptables -nL</span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">DOCKER-USER  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">DOCKER-ISOLATION-STAGE-1  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line">DOCKER     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line"></span><br><span class="line">Chain DOCKER (1 references)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">ACCEPT     tcp  --  0.0.0.0/0            172.17.0.2           tcp dpt:3306</span><br><span class="line"></span><br><span class="line">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">DOCKER-ISOLATION-STAGE-2  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain DOCKER-ISOLATION-STAGE-2 (1 references)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">DROP       all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain DOCKER-USER (1 references)</span><br><span class="line">target     prot opt source               destination         </span><br><span class="line">RETURN     all  --  0.0.0.0/0            0.0.0.0/0 </span><br></pre></td></tr></table></figure>

<p>容器之间通过名称ping通</p>
<p>1 –link&#x3D;容器01 这样会直接在容器02的hosts文件里写死容器01的ip 并且是单向的 容器01hosts不存在容器02映射（不推荐，容器01ip变化会导致容器02连接不到）</p>
<p>2 自定义桥接网络 接入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-17-centos ~]# docker network create --subnet=192.168.0.0/16 --gateway=192.168.0.1 mynet</span><br><span class="line">9c171be6b7f03908755097b68239dbdc363eb4bbed8e94c21061b5486417e64d</span><br><span class="line">[root@VM-12-17-centos ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">10bb6b5f0f1e   bridge    bridge    local</span><br><span class="line">1ed962b43486   host      host      local</span><br><span class="line">9c171be6b7f0   mynet     bridge    local</span><br><span class="line">bcb19ab636e4   none      null      local</span><br><span class="line">[root@VM-12-17-centos ~]# docker run -d -P --name mynginx01 --network=mynet nginx </span><br><span class="line">597c9e4c36ad1894c472f07ee9ab4da7acc2072e9043956a45aca3d9aff45419</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可用容器网络写 例如和mysql同一网络</span></span><br><span class="line">[root@VM-12-17-centos ~]# docker run -d -P --name mynginx01 --network=container:mysql nginx </span><br></pre></td></tr></table></figure>



<p><strong>docker多机网络</strong></p>
<ul>
<li><strong>overlay</strong></li>
</ul>
<p><strong>覆盖网络</strong> 常用的方式 多机容器解决方案</p>
<p>允许单个网络包含多个主机，不同主机上的容器通信</p>
<p>多机工作原理</p>
<p>VXLAN技术</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">DSAD</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/04/03/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BADocker%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/">http://example.com/2020/04/03/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BADocker%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Astrals</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C/">网络</a><a class="post-meta__tags" href="/tags/docker/">docker</a></div><div class="post_share"><div class="social-share" data-image="/./../images/docker.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/17/keepalived+MySQL%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Keepalived+MySQL实现高可用"><img class="cover" src="/./../images/Astral.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Keepalived+MySQL实现高可用</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/23/%E8%BD%AF%E8%80%83%E9%AB%98%E7%BA%A7-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%B8%88/" title="软考高级-系统架构师"><img class="cover" src="/./../images/%E9%A2%84%E8%A7%88%E5%9B%BE02.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">软考高级-系统架构师</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/11/01/%E6%B7%B1%E5%85%A5%E5%88%A8%E6%9E%90Kubernetes%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/" title="&lt;&lt;深入刨析Kubernetes&gt;&gt;读书记录"><img class="cover" src="/./../images/kubernetes.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="title">&lt;&lt;深入刨析Kubernetes&gt;&gt;读书记录</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">DSAD</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Astrals24/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">自己看,随缘更新,旨在记录一些大事情方便回忆,偶尔分享一些自己觉得不错的书籍笔记。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-%E5%90%AF%E5%8A%A8%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">docker 启动详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="toc-number">1.0.1.</span> <span class="toc-text">一些命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0-i-t-d%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.0.2.</span> <span class="toc-text">启动参数 -i -t -d是什么？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%90%AF%E5%8A%A8nginx%E5%AE%B9%E5%99%A8"><span class="toc-number">1.0.3.</span> <span class="toc-text">关于启动nginx容器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E7%9A%84%E5%BA%95%E5%B1%82%E5%AD%98%E5%82%A8"><span class="toc-number">2.</span> <span class="toc-text">镜像的底层存储</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#centos-root%E6%89%A9%E5%AE%B9"><span class="toc-number">2.0.1.</span> <span class="toc-text">centos-root扩容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E7%9A%84%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text">镜像的写时复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B7%E6%8C%82%E8%BD%BD%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">卷挂载方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile%E6%8C%87%E4%BB%A4"><span class="toc-number">5.</span> <span class="toc-text">Dockerfile指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA"><span class="toc-number">6.</span> <span class="toc-text">Dockerfile多阶段构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#daemon-json%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">7.</span> <span class="toc-text">daemon.json热更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E7%BD%91%E7%BB%9C"><span class="toc-number">8.</span> <span class="toc-text">docker网络</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/23/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/" title="为什么会是虚拟内存?"><img src="/./../images/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="为什么会是虚拟内存?"/></a><div class="content"><a class="title" href="/2023/01/23/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/" title="为什么会是虚拟内存?">为什么会是虚拟内存?</a><time datetime="2023-01-22T16:00:00.000Z" title="发表于 2023-01-23 00:00:00">2023-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/17/Go%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0/" title="深入理解Go"><img src="/./../images/go%E5%90%89%E7%A5%A5%E7%89%A94.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深入理解Go"/></a><div class="content"><a class="title" href="/2023/01/17/Go%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0/" title="深入理解Go">深入理解Go</a><time datetime="2023-01-16T16:00:00.000Z" title="发表于 2023-01-17 00:00:00">2023-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/09/linux%E5%86%85%E6%A0%B8%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/" title="&lt;&lt;Linux内核设计与实现&gt;&gt;读书记录"><img src="/./../images/Linux.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;&lt;Linux内核设计与实现&gt;&gt;读书记录"/></a><div class="content"><a class="title" href="/2022/06/09/linux%E5%86%85%E6%A0%B8%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/" title="&lt;&lt;Linux内核设计与实现&gt;&gt;读书记录">&lt;&lt;Linux内核设计与实现&gt;&gt;读书记录</a><time datetime="2022-06-08T16:00:00.000Z" title="发表于 2022-06-09 00:00:00">2022-06-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/01/%E6%B7%B1%E5%85%A5%E5%88%A8%E6%9E%90Kubernetes%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/" title="&lt;&lt;深入刨析Kubernetes&gt;&gt;读书记录"><img src="/./../images/kubernetes.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;&lt;深入刨析Kubernetes&gt;&gt;读书记录"/></a><div class="content"><a class="title" href="/2021/11/01/%E6%B7%B1%E5%85%A5%E5%88%A8%E6%9E%90Kubernetes%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/" title="&lt;&lt;深入刨析Kubernetes&gt;&gt;读书记录">&lt;&lt;深入刨析Kubernetes&gt;&gt;读书记录</a><time datetime="2021-10-31T16:00:00.000Z" title="发表于 2021-11-01 00:00:00">2021-11-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/17/keepalived+MySQL%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Keepalived+MySQL实现高可用"><img src="/./../images/Astral.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Keepalived+MySQL实现高可用"/></a><div class="content"><a class="title" href="/2021/10/17/keepalived+MySQL%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Keepalived+MySQL实现高可用">Keepalived+MySQL实现高可用</a><time datetime="2021-10-16T16:00:00.000Z" title="发表于 2021-10-17 00:00:00">2021-10-17</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By DSAD</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>